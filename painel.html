<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard SustentÃ¡vel 2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --green: #22c55e; --yellow: #eab308; --red: #ef4444; --text: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 15px; }
        .container { max-width: 600px; margin: auto; }
        
        h1 { text-align: center; font-size: 20px; margin-bottom: 15px; color: var(--green); }
        
        .search-box { width: 100%; padding: 12px; border-radius: 8px; border: none; background: var(--card); color: white; margin-bottom: 15px; border: 1px solid #334155; }
        
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--card); padding: 10px; border-radius: 10px; text-align: center; border-bottom: 3px solid var(--green); }
        .stat-val { display: block; font-size: 20px; font-weight: bold; }
        
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 5px; background: rgba(255,255,255,0.03); }
        .badge { padding: 4px 10px; border-radius: 6px; font-weight: bold; color: #000; font-size: 13px; }
        
        .loading-bar { height: 3px; background: var(--green); width: 0%; transition: 0.3s; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸŒ± GestÃ£o SustentÃ¡vel</h1>
    
    <div id="loader" class="loading-bar"></div>

    <div class="stats-grid">
        <div class="stat-card">Total de Salas<span id="totalSalas" class="stat-val">...</span></div>
        <div class="stat-card">MÃ©dia Geral<span id="mediaGeral" class="stat-val">...</span></div>
    </div>

    <input type="text" id="search" class="search-box" placeholder="ðŸ” Pesquisar sala (ex: 204)..." onkeyup="filtrarSalas()">

    <div class="card">
        <canvas id="chartRanking" style="max-height: 250px;"></canvas>
    </div>

    <div id="lista" class="card">
        <p style="text-align:center">A carregar 200+ salas...</p>
    </div>
</div>

<script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyETQ8TDDl1Xsb_wQuqorN2BiHJFG18kCPkcCdktFUlzuh-PV1E8pcRD71pPZQN6mJh/exec";
    let dadosOriginais = [];
    let meuGrafico;

    async function fetchData() {
        document.getElementById('loader').style.width = "50%";
        try {
            const res = await fetch(URL_SCRIPT);
            dadosOriginais = await res.json();
            atualizarPainel(dadosOriginais);
            document.getElementById('loader').style.width = "100%";
            setTimeout(() => document.getElementById('loader').style.width = "0%", 1000);
        } catch (e) {
            document.getElementById('lista').innerHTML = "Erro na conexÃ£o.";
        }
    }

    function getColor(nota) {
        if (nota >= 8) return '#22c55e'; // Verde
        if (nota >= 5) return '#eab308'; // Amarelo
        return '#ef4444'; // Vermelho
    }

    function atualizarPainel(dados) {
        // Stats
        document.getElementById('totalSalas').innerText = dados.length;
        const media = dados.reduce((acc, curr) => acc + parseFloat(curr.media), 0) / dados.length;
        document.getElementById('mediaGeral').innerText = media.toFixed(1);

        // Lista
        const lista = document.getElementById('lista');
        lista.innerHTML = dados.map((s, i) => `
            <div class="rank-item">
                <span><b>${i+1}Âº</b> ${s.gabinete}</span>
                <span class="badge" style="background:${getColor(s.media)}">${s.media}</span>
            </div>
        `).join('');

        // GrÃ¡fico (Top 10 para nÃ£o poluir)
        const top10 = dados.slice(0, 10);
        const ctx = document.getElementById('chartRanking').getContext('2d');
        
        if (meuGrafico) meuGrafico.destroy();
        
        meuGrafico = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top10.map(d => d.gabinete),
                datasets: [{
                    data: top10.map(d => d.media),
                    backgroundColor: top10.map(d => getColor(d.media)),
                    borderRadius: 5
                }]
            },
            options: { 
                indexAxis: 'y', // Barras horizontais para ler melhor os nomes
                plugins: { legend: { display: false } },
                scales: { x: { max: 10, ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } }
            }
        });
    }

    function filtrarSalas() {
        const termo = document.getElementById('search').value.toLowerCase();
        const filtrados = dadosOriginais.filter(d => d.gabinete.toLowerCase().includes(termo));
        atualizarPainel(filtrados);
    }

    // Auto-refresh a cada 60 segundos
    setInterval(fetchData, 60000);
    fetchData();
</script>
</body>
</html>
